{% extends 'base.html' %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center mb-2">
            <h2 class="me-3 mb-0">{{ meeting.title }}</h2>
            <span class="badge {{ 'bg-success' if meeting.status == 'Ongoing' else 'bg-secondary' }} me-3">
                {{ meeting.status }}
            </span>
            <a href="/meeting/{{ meeting.id }}/report" class="btn btn-outline-dark btn-sm" target="_blank">ðŸ“„ Minutes</a>
        </div>
        <p class="text-muted mb-0">
            {{ meeting.meeting_type }} | {{ meeting.location }} | {{ meeting.date.strftime('%b %d, %Y %I:%M %p') }}
        </p>
    </div>
    
    <div class="col-md-4 text-end">
        <div class="d-flex justify-content-end gap-2 mb-2">
            {% if meeting.status == 'Ongoing' %}
            <form action="/meeting/{{ meeting.id }}/adjourn" method="POST" onsubmit="return confirm('Wait! Did you log a Motion to Adjourn first?\n\nClick OK to finish the meeting.')">
                <button class="btn btn-danger">ðŸ›‘ Adjourn Meeting</button>
            </form>
            {% endif %}
        </div>
        
        <div class="card text-center {{ 'bg-success text-white' if quorum_met else 'bg-danger text-white' }} d-inline-block w-100">
            <div class="card-body p-2">
                <h5 class="card-title mb-0">{% if quorum_met %}QUORUM MET{% else %}NO QUORUM{% endif %}</h5>
                <small>{{ present_count }} / {{ meeting.quorum_required }} Present</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>Roll Call</span>
                <button type="submit" form="attendanceForm" class="btn btn-sm btn-light">Update</button>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                <form id="attendanceForm" action="/meeting/{{ meeting.id }}/attendance" method="POST">
                    <table class="table table-sm table-hover mb-0">
                        <tbody>
                            {% for member in members %}
                            <tr>
                                <td class="ps-3">{{ member.last_name }}, {{ member.first_name }}</td>
                                <td>
                                    {% set current_status = attendance_map.get(member.id, 'Absent') %}
                                    <select name="status_{{ member.id }}" class="form-select form-select-sm border-0 bg-transparent">
                                        <option value="Absent" {% if current_status == 'Absent' %}selected{% endif %}>Absent</option>
                                        <option value="Present" {% if current_status == 'Present' %}selected{% endif %}>Present</option>
                                        <option value="Excused" {% if current_status == 'Excused' %}selected{% endif %}>Excused</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">Agenda</div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for item in agenda_items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ loop.index }}. {{ item.title }}
                        </li>
                    {% else %}
                    <li class="list-group-item text-muted text-center">No agenda items set.</li>
                    {% endfor %}
                </ul>
                <div class="p-2 border-top">
                    <form action="/meeting/{{ meeting.id }}/add_agenda_item" method="POST" class="input-group input-group-sm">
                        <input type="text" name="title" class="form-control" placeholder="Add item during meeting..." required>
                        <button class="btn btn-outline-secondary">+</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <ul class="nav nav-tabs" id="meetingTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="motions-tab" data-bs-toggle="tab" data-bs-target="#motions">Motions</button></li>
            <li class="nav-item"><button class="nav-link" id="minutes-tab" data-bs-toggle="tab" data-bs-target="#minutes">Minutes Log</button></li>
        </ul>

        <div class="tab-content bg-white border border-top-0 p-3 shadow-sm" id="meetingTabsContent">
            
            <div class="tab-pane fade show active" id="motions">
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <form action="/meeting/{{ meeting.id }}/motion" method="POST">
                            <textarea name="text" class="form-control mb-2" rows="2" placeholder="Describe the motion..." required></textarea>
                            
                            <select name="agenda_item_id" class="form-select form-select-sm mb-2 text-primary fw-bold">
                                <option value="">(General / No Specific Agenda Item)</option>
                                {% for item in agenda_items %}
                                <option value="{{ item.id }}">Re: {{ item.title }}</option>
                                {% endfor %}
                            </select>

                            <div class="row g-2 mb-2">
                                <div class="col">
                                    <select name="proposer_id" class="form-select form-select-sm">
                                        <option value="">Proposer...</option>
                                        {% for m in members %}
                                        <option value="{{ m.id }}">{{ m.last_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <select name="seconder_id" class="form-select form-select-sm">
                                        <option value="">Seconder...</option>
                                        {% for m in members %}
                                        <option value="{{ m.id }}">{{ m.last_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col">
                                    <select name="status" class="form-select form-select-sm">
                                        <option value="Pending">Pending</option>
                                        <option value="Passed">Passed</option>
                                        <option value="Failed">Failed</option>
                                    </select>
                                </div>
                                <div class="col"><input type="text" name="vote_results" class="form-control form-control-sm" placeholder="Votes (e.g. 10-2)"></div>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary w-100">Record Motion</button>
                        </form>
                    </div>
                </div>

                <div style="max-height: 400px; overflow-y: auto;">
                    {% for motion in motions %}
                    <div class="card mb-2 border-start border-4 {{ 'border-success' if motion.status == 'Passed' else 'border-danger' if motion.status == 'Failed' else 'border-warning' }}">
                        <div class="card-body p-2 position-relative">
                            <a href="/motion/delete/{{ motion.id }}" class="position-absolute top-0 end-0 p-2 text-danger text-decoration-none" onclick="return confirm('Delete?')">&times;</a>
                            
                            {% if motion.agenda_item %}
                            <span class="badge bg-info text-dark mb-1">Re: {{ motion.agenda_item.title }}</span>
                            {% endif %}

                            <p class="mb-1 fw-bold pe-3">{{ motion.text }}</p>
                            <div class="small text-dark mb-1">
                                Proposed: <strong>{% for m in members %}{% if m.id == motion.proposer_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                                | Seconded: <strong>{% for m in members %}{% if m.id == motion.seconder_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                            </div>
                            <small class="text-muted">Status: {{ motion.status }} | Votes: {{ motion.vote_results }}</small>
                        </div>
                    </div>
                    {% else %}<p class="text-muted small">No motions.</p>{% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="minutes">
                <form action="/meeting/{{ meeting.id }}/statement" method="POST" class="mb-3">
                    <select name="agenda_item_id" class="form-select form-select-sm mb-2 text-primary fw-bold">
                        <option value="">(General Discussion)</option>
                        {% for item in agenda_items %}
                        <option value="{{ item.id }}">Re: {{ item.title }}</option>
                        {% endfor %}
                    </select>

                    <div class="input-group">
                        <select name="speaker_id" class="form-select" style="max-width: 140px;">
                            <option value="">Speaker...</option>
                            {% for m in members %}<option value="{{ m.id }}">{{ m.last_name }}</option>{% endfor %}
                        </select>
                        <textarea name="content" class="form-control" rows="1" placeholder="Statement..." required></textarea>
                    </div>
                    <button class="btn btn-sm btn-secondary w-100 mt-1">Log</button>
                </form>

                <div style="max-height: 400px; overflow-y: auto;">
                    {% for stmt in statements %}
                    <div class="mb-2 position-relative">
                        <small class="text-muted d-block">
                            {{ stmt.timestamp.strftime('%H:%M') }} 
                            {% if stmt.agenda_item %} <span class="badge bg-light text-dark border ms-1">{{ stmt.agenda_item.title }}</span>{% endif %}
                            - <strong>{% for m in members %}{% if m.id == stmt.speaker_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                            <a href="/statement/delete/{{ stmt.id }}" class="text-danger ms-2 text-decoration-none" onclick="return confirm('Delete?')">[x]</a>
                        </small>
                        <span class="d-block bg-light p-2 rounded small">{{ stmt.content }}</span>
                    </div>
                    {% else %}<p class="text-muted small">Empty log.</p>{% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var activeTabId = localStorage.getItem('activeMeetingTab');
        if (activeTabId) {
            var tabButton = document.querySelector(activeTabId);
            if (tabButton) { (new bootstrap.Tab(tabButton)).show(); }
        }
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(btn) {
            btn.addEventListener('shown.bs.tab', function(event) {
                localStorage.setItem('activeMeetingTab', '#' + event.target.id);
            });
        });
    });
</script>

{% endblock %}