{% extends 'base.html' %}

{% block content %}
<div class="page-section">
    <div class="card shadow-soft border-0 mb-4">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div>
                <div class="pill pill-muted mb-2">{{ meeting.meeting_type }}</div>
                <div class="d-flex align-items-center gap-2 mb-1">
                    <h2 class="mb-0">{{ meeting.title }}</h2>
                    <span class="pill {{ 'pill-live' if meeting.status == 'Ongoing' else 'pill-muted' }}">{{ meeting.status }}</span>
                </div>
                <div class="text-muted">{{ meeting.location or 'Location TBA' }} â€¢ {{ meeting.date.strftime('%b %d, %Y %I:%M %p') }}</div>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                <a href="/meeting/{{ meeting.id }}/report" class="btn btn-outline-primary" target="_blank">Open Minutes</a>
                {% if meeting.status == 'Ongoing' %}
                <form action="/meeting/{{ meeting.id }}/adjourn" method="POST" onsubmit="return confirm('Did you log a motion to adjourn? This will finish the meeting.')">
                    <button class="btn btn-danger">Adjourn</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5 d-flex flex-column gap-4">
            <div class="card shadow-soft border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <strong>Roll Call</strong>
                    <button type="submit" form="attendanceForm" class="btn btn-sm btn-primary">Update</button>
                </div>
                <div class="card-body p-0" style="max-height: 340px; overflow-y: auto;">
                    <form id="attendanceForm" action="/meeting/{{ meeting.id }}/attendance" method="POST">
                        <table class="table table-sm align-middle mb-0">
                            <tbody>
                                {% for member in members %}
                                <tr>
                                    <td class="ps-3">{{ member.last_name }}, {{ member.first_name }}</td>
                                    <td>
                                        {% set current_status = attendance_map.get(member.id, 'Absent') %}
                                        <select name="status_{{ member.id }}" class="form-select form-select-sm">
                                            <option value="Absent" {% if current_status == 'Absent' %}selected{% endif %}>Absent</option>
                                            <option value="Present" {% if current_status == 'Present' %}selected{% endif %}>Present</option>
                                            <option value="Excused" {% if current_status == 'Excused' %}selected{% endif %}>Excused</option>
                                        </select>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="p-3 border-top">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">Quorum</div>
                        <div class="pill {{ 'pill-live' if quorum_met else 'pill-muted' }}">{{ present_count }} / {{ meeting.quorum_required }} present</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-soft border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <strong>Agenda</strong>
                    <span class="text-muted small">{{ agenda_items|length }} item{{ 's' if agenda_items|length != 1 else '' }}</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for item in agenda_items %}
                        <li class="list-group-item">{{ loop.index }}. {{ item.title }}</li>
                        {% else %}
                        <li class="list-group-item text-muted text-center">No agenda items set.</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="p-3 border-top">
                    <form action="/meeting/{{ meeting.id }}/add_agenda_item" method="POST" class="input-group input-group-sm">
                        <input type="text" name="title" class="form-control" placeholder="Add item during meeting..." required>
                        <button class="btn btn-outline-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <ul class="nav nav-tabs" id="meetingTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="motions-tab" data-bs-toggle="tab" data-bs-target="#motions">Motions</button></li>
                <li class="nav-item"><button class="nav-link" id="minutes-tab" data-bs-toggle="tab" data-bs-target="#minutes">Minutes Log</button></li>
            </ul>

            <div class="tab-content bg-white border border-top-0 p-3 shadow-sm" id="meetingTabsContent">
                <div class="tab-pane fade show active" id="motions">
                    <div class="card card-quiet mb-3">
                        <div class="card-body">
                            <form action="/meeting/{{ meeting.id }}/motion" method="POST" class="d-flex flex-column gap-2">
                                <textarea name="text" class="form-control" rows="2" placeholder="Describe the motion..." required></textarea>
                                <select name="agenda_item_id" id="motionAgendaSelect" class="form-select form-select-sm text-primary fw-bold">
                                    <option value="">(General / No Specific Agenda Item)</option>
                                    {% for item in agenda_items %}
                                    <option value="{{ item.id }}">Re: {{ item.title }}</option>
                                    {% endfor %}
                                </select>
                                <div class="row g-2">
                                    <div class="col">
                                        <select name="proposer_id" class="form-select form-select-sm">
                                            <option value="">Proposer...</option>
                                            {% for m in members %}
                                            <option value="{{ m.id }}">{{ m.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col">
                                        <select name="seconder_id" class="form-select form-select-sm">
                                            <option value="">Seconder...</option>
                                            {% for m in members %}
                                            <option value="{{ m.id }}">{{ m.last_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col">
                                        <select name="status" class="form-select form-select-sm">
                                            <option value="Pending">Pending</option>
                                            <option value="Passed">Passed</option>
                                            <option value="Failed">Failed</option>
                                        </select>
                                    </div>
                                    <div class="col"><input type="text" name="vote_results" class="form-control form-control-sm" placeholder="Votes (e.g. 10-2)"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">Record Motion</button>
                            </form>
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-2">
                        {% for motion in motions %}
                        <div class="card mb-0 border-start border-4 {{ 'border-success' if motion.status == 'Passed' else 'border-danger' if motion.status == 'Failed' else 'border-warning' }}">
                            <div class="card-body p-2 position-relative">
                                <a href="/motion/delete/{{ motion.id }}" class="position-absolute top-0 end-0 p-2 text-danger text-decoration-none" onclick="return confirm('Delete?')">&times;</a>
                                {% if motion.agenda_item %}
                                <span class="badge bg-info text-dark mb-1">Re: {{ motion.agenda_item.title }}</span>
                                {% endif %}
                                <p class="mb-1 fw-semibold pe-4">{{ motion.text }}</p>
                                <div class="small text-dark mb-1">
                                    Proposed: <strong>{% for m in members %}{% if m.id == motion.proposer_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                                    | Seconded: <strong>{% for m in members %}{% if m.id == motion.seconder_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                                </div>
                                <small class="text-muted">Status: {{ motion.status }}{% if motion.vote_results %} | Votes: {{ motion.vote_results }}{% endif %}</small>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted small">No motions recorded.</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-pane fade" id="minutes">
                    <form action="/meeting/{{ meeting.id }}/statement" method="POST" class="card card-quiet mb-3">
                        <div class="card-body d-flex flex-column gap-2">
                            <select name="agenda_item_id" id="minutesAgendaSelect" class="form-select form-select-sm text-primary fw-bold">
                                <option value="">(General Discussion)</option>
                                {% for item in agenda_items %}
                                <option value="{{ item.id }}">Re: {{ item.title }}</option>
                                {% endfor %}
                            </select>
                            <div class="input-group">
                                <select name="speaker_id" class="form-select" style="max-width: 140px;">
                                    <option value="">Speaker...</option>
                                    {% for m in members %}<option value="{{ m.id }}">{{ m.last_name }}</option>{% endfor %}
                                </select>
                                <textarea name="content" class="form-control" rows="1" placeholder="Statement..." required></textarea>
                            </div>
                            <button class="btn btn-outline-primary">Log Statement</button>
                        </div>
                    </form>

                    <div class="d-flex flex-column gap-2">
                        {% for stmt in statements %}
                        <div class="card card-quiet mb-0 position-relative">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-2 mb-1 text-muted small">
                                    {{ stmt.timestamp.strftime('%H:%M') }}
                                    {% if stmt.agenda_item %}
                                    <span class="badge bg-light text-dark border">{{ stmt.agenda_item.title }}</span>
                                    {% endif %}
                                    <span>-</span>
                                    <strong>{% for m in members %}{% if m.id == stmt.speaker_id %}{{ m.last_name }}{% endif %}{% endfor %}</strong>
                                    <a href="/statement/delete/{{ stmt.id }}" class="text-danger ms-auto text-decoration-none" onclick="return confirm('Delete?')">Remove</a>
                                </div>
                                <div class="bg-light p-2 rounded small">{{ stmt.content }}</div>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted small">No statements yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var activeTabId = localStorage.getItem('activeMeetingTab');
        if (activeTabId) {
            var tabButton = document.querySelector(activeTabId);
            if (tabButton) { (new bootstrap.Tab(tabButton)).show(); }
        }
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(btn) {
            btn.addEventListener('shown.bs.tab', function(event) {
                localStorage.setItem('activeMeetingTab', '#' + event.target.id);
            });
        });

        const agendaSelects = ['motionAgendaSelect', 'minutesAgendaSelect'];
        agendaSelects.forEach(function(id) {
            const el = document.getElementById(id);
            if (el) {
                const savedVal = localStorage.getItem('sticky_' + id);
                if (savedVal) {
                    el.value = savedVal;
                }
                el.addEventListener('change', function() {
                    localStorage.setItem('sticky_' + id, this.value);
                });
            }
        });
    });
</script>

{% endblock %}